#Generate DKD Interval Data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=F)
```

##Determine if diagnosis dates are known

Load libraries
```{r}
library(tidyverse)
library(lubridate)
library(data.table)
```
Load DKD first occurence data and entire GP clinical data
```{r}
dkd_firstoccur <- readRDS("generated_data/dkd_firstoccur.RDS")
dkd_firstoccur <- dkd_firstoccur %>% select('f.eid', 'event_dt')
entire_gp_clinical <- fread("generated_data/entire_gp_clinical_30March2021_formatted.txt", select = c('f.eid', 'event_dt'))
```
Determine whether or not each patient has two years of GP clincial data prior to their DKD diagnosis
```{r}
known_date_gp <- entire_gp_clinical %>% mutate(yr = year(event_dt)) 
known_date_gp <- known_date_gp %>% distinct(f.eid, yr)
known_date_gp <- merge(known_date_gp, dkd_firstoccur, by='f.eid') %>% filter(year(event_dt)-1==yr | year(event_dt)-2==yr)
known_date_gp <- known_date_gp %>% subset(duplicated(f.eid)) %>% distinct(f.eid, event_dt)
```
Add field to dkd_firstoccur ta flag known and unknown diagnosis dates
```{r}
dkd_date_known <- dkd_firstoccur %>% mutate(known = ifelse(f.eid %in% known_date_gp$f.eid,1,0))
```
Save table containing dr_date_known
```{r}
saveRDS(dkd_date_known, "generated_data/dr_date_known.RDS")
```
##Define intervals 

Load DM diagnosis table, DKD diagnosis table, demographic information, egfr trajectory data (which includes creatinine levels), and microalbuminuria diagnosis dates
```{r}
dm_date_known <- readRDS('generated_data/dm_date_known.RDS')
dkd_date_known <- readRDS('generated_data/dr_date_known.RDS')
demog <- readRDS("generated_data/demog_selected.RDS")
egfr_traj <- readRDS("generated_data/trajectory_egfr.RDS")
microabu_firstoccur <- readRDS("generated_data/microabu_firstoccur.RDS")
```
Load control exclusion events
```{r}
dkd_control_exclusion_events_ukb <- readRDS("generated_data/dkd_control_exclusion_events_ukb.RDS")
kidney_disease_control_exclusion_events_pc <- readRDS("generated_data/kidney_disease_control_exclusion_pc.RDS")
```

Create additional control exclusion event tables based on whether or not creatinine has ever been measured below 60 and whether or not patient has ever had microalbuminuria
```{r}
egfr_lt60_ever_event_tab <- egfr_traj %>% filter(measurement < 60, !is.na(measurement), !is.na(event_dt))
microabu_ever_event_tab <- microabu_firstoccur %>% filter(!is.na(event))
```

Merge data from the four exclusion event tables
```{r}
ckd_control_exclusion_events <- bind_rows(list(dkd_control_exclusion_events_ukb,
            kidney_disease_control_exclusion_events_pc,
            egfr_lt60_ever_event_tab,microabu_ever_event_tab))
```
Define control exclusion subject IDs
```{r}
ctrl_exclusion_ids <- ckd_control_exclusion_events$f.eid %>% unique
```

Load primary care data set and information on whether or not egfr measurements were available for patients
```{r}
pcp_subject_ids <- readRDS("generated_data/gp_subject_ids.RDS")
eGFR_avail_subject_ids <- (egfr_traj %>% filter(!is.na(measurement) & !is.na(event_dt))) %>% .$f.eid
```

Define control inclusion subject IDs
```{r}
ctrl_inclusion_ids <- intersect(pcp_subject_ids,eGFR_avail_subject_ids) %>% unique
```
Define upper and lower bounds for time-to-event with DKD diagnosis 
```{r}
#Combine DM and DR diagnosis dates and whether or not they are known
tab <- dm_date_known %>% left_join(dkd_date_known, by='f.eid', suffix = c('_dm', '_comp'))

#Mark whether or not DKD occured
tab <- tab %>% mutate(event = ifelse(is.na(event_dt_comp), 0, 1))

#Mark cases where a complication exsts before DM diagnosis
tab <- tab %>% mutate(prior_comp = (event_dt_dm > event_dt_comp))

#Incorporate demographic data to access censoring dates
tab <- tab %>% left_join(demog %>% select('f.eid', 'date_censored'), by='f.eid')

#Mark controls which are not usable because the DM diagnosis was after the censoring date
tab <- tab %>% mutate(nonsense_ctrl = (event_dt_dm > date_censored))

#Mark cases which are not usable because the DKD diagnosis was after the censoring date
tab <- tab %>% mutate(nonsense_case = (event_dt_comp > date_censored))

#Mark controls which were censored less than 5 years after diagnosis of DM
tab <- tab %>% mutate(fut_less_than_5yrs = ((lubridate::decimal_date(date_censored) - lubridate::decimal_date(event_dt_dm) < 5)))

#Mark whether or not controls should be excludeed based on previously defined control exclusion evnets
tab <- tab %>% mutate(ctrl_exclude = f.eid %in% ctrl_exclusion_ids)

#Mark whether or not patients are included in primary care data
tab <- tab %>% mutate(ctrl_include = f.eid %in% ctrl_inclusion_ids)

#Filter out patients based on criteria defined above
tab <- tab %>% filter(event == 0 | (event == 1 & nonsense_case == 0 & prior_comp == 0 & known_dm==1)) %>% filter(event == 1 | (event == 0 & nonsense_ctrl == 0 & ctrl_exclude == 0 & ctrl_include == 1 & fut_less_than_5yrs == 0 & known_dm==1))

#Create an upper bound for time-to-event from DM diagnosis to DKD diagnosis for cases and from DM diagnosis to censoring date for controls
tab <- tab %>% mutate(upper = ifelse(event, decimal_date(event_dt_comp)-decimal_date(event_dt_dm), decimal_date(date_censored)-decimal_date(event_dt_dm)))

#Filter egfr measurements greater than 90 (indicating kidney health)
egfr_gt90 <- egfr_traj %>% select('f.eid', 'measurement', 'event_dt') %>% filter('mearsurement'>90)

#Merge egfr dates with dm and dkd dates
egfr_date <- egfr_traj %>% merge(tab, by='f.eid') %>% select('f.eid', 'event_dt_dm', 'event_dt_comp', 'event_dt')

#Find only egfr dates between DM and DKD dates
egfr_date <- egfr_date %>% filter(event_dt<event_dt_comp & event_dt>event_dt_dm)

#Eliminate all but the most recent egfr date for each subject
egfr_date <- aggregate(egfr_date$event_dt, by=list(egfr_date$f.eid), max)

#Rename egfr date to 'event_dt_egfr' for clarity
egfr_date <- egfr_date %>% rename('f.eid'='Group.1', 'event_dt_egfr'='x')

#Combine egfr dates back into the original data table
tab <- tab %>% left_join(egfr_date, by='f.eid')

#Create lower bound for time-to-event. If DKD date is known, the lower and upper bound are equal. If DKD date is unknown but an egfr >90 exists between DM diagnosis and DKD diagnosis then the lower bound is from DM to egfr. If no egfr is present in this period, the lower bound is 0. 
tab <- tab %>% mutate(lower = ifelse(is.na(known_comp) | known_comp, upper, ifelse(is.na(event_dt_egfr),0, decimal_date(event_dt_egfr)-decimal_date(event_dt_dm))))

#Filter cases with a lower bound less than 5 years. Setting the cases to only have bounds above 5 years increases the likelihood that cases are diabetes-related
tab <- tab %>% filter(event & lower>5)

#Select only necessary information (i.e. f.eid, whether or not the event occured, whether or not the date was known, and the upper and lower bounds on time-to-event)
dkd_interval <- tab %>% select('f.eid', 'known' = 'known_comp','event', 'lower', 'upper')
```
Save the DKD time-to-event intervals
```{r}
saveRDS(dkd_interval, 'generated_data/dr_tte_interval.RDS')
```



