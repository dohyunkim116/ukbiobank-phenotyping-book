#Generate DKD Interval Data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=F)
```

##Determine if diagnosis dates are known

Load libraries
```{r}
library(tidyverse)
library(lubridate)
library(data.table)
source("functions.R")
```
Load DKD first occurence data and entire GP clinical data
```{r}
dkd_firstoccur <- readRDS("generated_data/dkd_firstoccur.RDS")
dkd_firstoccur <- dkd_firstoccur %>% select('f.eid', 'event_dt')
entire_gp_clinical <- fread("generated_data/entire_gp_clinical_30March2021_formatted.txt", select = c('f.eid', 'event_dt'))
```
Determine whether or not each patient has two years of GP clincial data prior to their DKD diagnosis
```{r}
known_date_gp <- entire_gp_clinical %>% mutate(yr = year(event_dt)) 
known_date_gp <- known_date_gp %>% distinct(f.eid, yr)
known_date_gp <- merge(known_date_gp, dkd_firstoccur, by='f.eid') %>% filter(year(event_dt)-1==yr | year(event_dt)-2==yr)
known_date_gp <- known_date_gp %>% subset(duplicated(f.eid)) %>% distinct(f.eid, event_dt)
```
Add field to dkd_firstoccur ta flag known and unknown diagnosis dates
```{r}
dkd_date_known <- dkd_firstoccur %>% mutate(known = ifelse(f.eid %in% known_date_gp$f.eid,1,0))
```
Save table containing dr_date_known
```{r}
saveRDS(dkd_date_known, "generated_data/dr_date_known.RDS")
```
##Define intervals 

Load DM diagnosis table, DKD diagnosis table, demographic information, egfr trajectory data (which includes creatinine levels), and microalbuminuria diagnosis dates
```{r}
dm_date_known <- readRDS('generated_data/dm_date_known.RDS')
dkd_date_known <- readRDS('generated_data/dr_date_known.RDS')
demog <- readRDS("generated_data/demog_selected.RDS")
egfr_traj <- readRDS("generated_data/trajectory_egfr.RDS")
microabu_firstoccur <- readRDS("generated_data/microabu_firstoccur.RDS")
```
Load control exclusion events
```{r}
dkd_control_exclusion_events_ukb <- readRDS("generated_data/dkd_control_exclusion_events_ukb.RDS")
kidney_disease_control_exclusion_events_pc <- readRDS("generated_data/kidney_disease_control_exclusion_pc.RDS")
```

Create additional control exclusion event tables based on whether or not creatinine has ever been measured below 60 and whether or not patient has ever had microalbuminuria
```{r}
egfr_lt60_ever_event_tab <- egfr_traj %>% filter(measurement < 60, !is.na(measurement), !is.na(event_dt))
microabu_ever_event_tab <- microabu_firstoccur %>% filter(!is.na(event))
```

Merge data from the four exclusion event tables
```{r}
ckd_control_exclusion_events <- bind_rows(list(dkd_control_exclusion_events_ukb,
            kidney_disease_control_exclusion_events_pc,
            egfr_lt60_ever_event_tab,microabu_ever_event_tab))
```
Define control exclusion subject IDs
```{r}
ctrl_exclusion_ids <- ckd_control_exclusion_events$f.eid %>% unique
```

Load primary care data set and information on whether or not egfr measurements were available for patients
```{r}
pcp_subject_ids <- readRDS("generated_data/gp_subject_ids.RDS")
eGFR_avail_subject_ids <- (egfr_traj %>% filter(!is.na(measurement) & !is.na(event_dt))) %>% .$f.eid
```

Define control inclusion subject IDs
```{r}
ctrl_inclusion_ids <- intersect(pcp_subject_ids,eGFR_avail_subject_ids) %>% unique
```
Generate the alternative dates for the complication event using egfr_traj and then generate the time-to-event intervals
```{r}
#Find egfr readings of more than 90 (indicating healty kidney function) and match them with subjects
egfr_gt90 <- egfr_traj %>% select('f.eid', 'measurement', 'event_dt') %>% filter('mearsurement'>90)
egfr_date <- dm_date_known %>% left_join(dkd_date_known, by='f.eid', suffix=c('_dm','_comp')) %>% merge(egfr_gt90, by='f.eid')

#Remove egfr dates which do not fall between dm and dkd diagnosis
egfr_date <- egfr_date %>% filter(event_dt<event_dt_comp & event_dt>event_dt_dm)

#Remove all but the most recent date for each patient
egfr_date <- aggregate(egfr_date$event_dt, by=list(egfr_date$f.eid), max)
egfr_date <- egfr_date %>% rename('f.eid'='Group.1', 'event_dt'='x')

#Generate intervals by running the phenotype_time_to_event_interval function on the dm dates, the dkd dates, the demographic information, the control exclusion and inclusion events, the egfr dates, and set the option to filter out cases with less than 5 years between dm and dkd development to true 
dkd_interval_result <- phenotype_time_to_event_interval(dm_date_known, dkd_date_known, demog, ctrl_exclusion_ids, ctrl_inclusion_ids, comp_alternative=egfr_date, filter_cases_lt5yrs=1)
```
Save the DKD time-to-event intervals
```{r}
saveRDS(dkd_interval_result, 'generated_data/dr_tte_interval.RDS')
```



