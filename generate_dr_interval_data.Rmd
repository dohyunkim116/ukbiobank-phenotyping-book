#Generate intervals for time-to-event DR

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=F)
```

##Determine if diagnosis dates are known

Load libraries
```{r}
library(tidyverse)
library(lubridate)
library(data.table)
source("functions.R")
```
Load DR first occurence data and entire GP clinical data
```{r}
dr_firstoccur <- readRDS("generated_data/dr_firstoccur.RDS")
dr_firstoccur <- dr_firstoccur %>% select('f.eid', 'event_dt')
entire_gp_clinical <- fread("generated_data/entire_gp_clinical_30March2021_formatted.txt", select = c('f.eid', 'event_dt'))
```
Determine whether or not each patient has two years of GP clincial data prior to their DR diagnosis
```{r}
known_date_gp <- entire_gp_clinical %>% mutate(yr = year(event_dt)) 
known_date_gp <- known_date_gp %>% distinct(f.eid, yr)
known_date_gp <- merge(known_date_gp, dr_firstoccur, by='f.eid') %>% filter(year(event_dt)-1==yr | year(event_dt)-2==yr)
known_date_gp <- known_date_gp %>% subset(duplicated(f.eid)) %>% distinct(f.eid, event_dt)
```
Add field to dm_firstoccur ta flag known and unknown diagnosis dates
```{r}
dr_date_known <- dr_firstoccur %>% mutate(known = ifelse(f.eid %in% known_date_gp$f.eid,1,0))
```
Save table containing dr_date_known
```{r}
saveRDS(dr_date_known, "generated_data/dr_date_known.RDS")
```
##Define intervals 

Load DM diagnosis table, DR diagnosis table, and demographic information
```{r}
dm_date_known <- readRDS('generated_data/dm_date_known.RDS')
dr_date_known <- readRDS('generated_data/dr_date_known.RDS')
demog <- readRDS("generated_data/demog_selected.RDS")
```
Load control exclusion events
```{r}
dr_control_exclusion_events_ukb <- readRDS("generated_data/dr_control_exclusion_events_ukb.RDS")
nondm_eye_disease <- readRDS("generated_data/nondm_eye_disease_pc.RDS")
```

Merge data from the two exclusion event tables
```{r}
dr_control_exclusion_events <- full_join(dr_control_exclusion_events_ukb,nondm_eye_disease,by=c("f.eid","event_dt"))
```
Define control exclusion subject IDs
```{r}
ctrl_exclusion_ids <- dr_control_exclusion_events$f.eid %>% unique
```

Load primary care data set
```{r}
gp_subject_ids <- readRDS("generated_data/gp_subject_ids.RDS")
```

Define control inclusion subject IDs
```{r}
ctrl_inclusion_ids <- gp_subject_ids %>% unique
```
Define upper and lower bounds for time-to-event with DR diagnosis 
```{r}
#Use the phenotype_time_to_event_interval function to generate the upper and lower bounds by passing in dm dates with known flags, dr dates with known flags, demographic information, control exclusion and inclusion ids, and a 0 for comp_alternative which indicates that a 0 will be used for the lower bound on unknown intervals. 
dr_interval_result <- phenotype_time_to_event_interval(dm_date_known, dr_date_known, demog, ctrl_exclusion_ids, ctrl_inclusion_ids, comp_alternative=0)
```
Save the DR time-to-event intervals
```{r}
saveRDS(dr_interval_result, 'generated_data/dr_tte_interval.RDS')
```

